import express from "express";
import fetch from "node-fetch";
import { generatePKCE } from "./oauth";
import { saveTokens } from "./db";
import crypto from "crypto";

const router = express.Router();
const pkceStore: Record<string, string> = {};

// Step 1: Kick off OAuth
router.get("/auth/x/start", (req, res) => {
  const state = crypto.randomBytes(16).toString("hex");
  const { verifier, challenge } = generatePKCE();
  pkceStore[state] = verifier;

  const params = new URLSearchParams({
    response_type: "code",
    client_id: process.env.X_CLIENT_ID!,
    redirect_uri: "https://api.mirancourt.com/auth/x/callback",
    scope: "tweet.read tweet.write users.read offline.access",
    state,
    code_challenge: challenge,
    code_challenge_method: "S256",
  });

  res.redirect(`https://twitter.com/i/oauth2/authorize?${params.toString()}`);
});

// Step 2: Handle callback
router.get("/auth/x/callback", async (req, res) => {
  const { code, state } = req.query;

  if (!code || !state) {
    return res.status(400).send("Missing code or state");
  }

  const verifier = pkceStore[state as string];
  if (!verifier) {
    return res.status(400).send("Invalid or expired state");
  }

  try {
    const tokenResponse = await fetch("https://api.twitter.com/2/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        code: code as string,
        grant_type: "authorization_code",
        client_id: process.env.X_CLIENT_ID!,
        client_secret: process.env.X_CLIENT_SECRET!,
        redirect_uri: "https://api.mirancourt.com/auth/x/callback",
        code_verifier: verifier,
      }),
    });

    const data = await tokenResponse.json();
    console.log("OAuth Token Response:", data);

    // Example: save tokens for user "default"
    await saveTokens("default", data);

    res.send("Twitter connected successfully. Tokens saved.");
  } catch (err) {
    console.error("OAuth error:", err);
    res.status(500).send("OAuth callback failed");
  }
});

export default router;
